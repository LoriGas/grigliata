<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grigliata Casa Gas - Con Firebase (v3)</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet" />
<style>
  /* stesso stile della versione migliorata */
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <h1>Grigliata Casa Gas</h1>
  <div class="subtitle">Seleziona cosa porti, aggiungiti alla lista e guarda le preferenze del gruppo.</div>
</header>
<div class="section">
  <label for="nome">Nome</label>
  <input type="text" id="nome" autocomplete="off" placeholder="Inserisci il tuo nome" />
</div>
<div class="grid">
  <div class="section">
    <h3>Cibi</h3>
    <div id="cibi" class="checkbox-group"></div>
  </div>
  <div class="section">
    <h3>Bevande</h3>
    <div id="bevande" class="checkbox-group"></div>
  </div>
</div>
<div class="section actions">
  <button onclick="aggiungiPartecipante()">Aggiungi</button>
  <span class="pill" id="totPartecipanti">0 partecipanti</span>
</div>
<h2>Lista partecipanti</h2>
<ul id="lista"></ul>
<div class="charts">
  <div class="chart-card">
    <div class="chart-title">Cibi</div>
    <canvas id="graficoCibi" width="400" height="200" aria-label="Grafico a barre cibi"></canvas>
  </div>
  <div class="chart-card">
    <div class="chart-title">Bevande</div>
    <canvas id="graficoBevande" width="400" height="200" aria-label="Grafico a barre bevande"></canvas>
  </div>
</div>
<script>
  const firebaseConfig = { /* config */ };
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const opzioniCibi = ["Hamburger", "Salamelle", "Braciole", "Wurstel", "Salsiccia", "Coppa", "Pancetta"];
  const opzioniBevande = ["Acqua", "CocaCola", "Spritz", "Birra", "Estathe", "Gin", "Apertass"];
  function creaCheckbox(containerId, opzioni) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    opzioni.forEach(opt => {
      const label = document.createElement('label');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = opt;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(' ' + opt));
      container.appendChild(label);
    });
  }
  creaCheckbox('cibi', opzioniCibi);
  creaCheckbox('bevande', opzioniBevande);
  const listaEl = document.getElementById('lista');
  const nomeInput = document.getElementById('nome');
  const totPartecipantiEl = document.getElementById('totPartecipanti');
  let graficoCibi, graficoBevande;
  function aggiungiPartecipante() {
    const nome = nomeInput.value.trim();
    if (!nome) { alert('Inserisci un nome'); return; }
    const cibiSelezionati = Array.from(document.querySelectorAll('#cibi input:checked')).map(cb => cb.value);
    const bevandeSelezionate = Array.from(document.querySelectorAll('#bevande input:checked')).map(cb => cb.value);
    if(cibiSelezionati.length === 0 && bevandeSelezionate.length === 0) {
      alert('Seleziona almeno un cibo o una bevanda');
      return;
    }
    const newRef = database.ref('partecipanti').push();
    newRef.set({ nome, cibi: cibiSelezionati, bevande: bevandeSelezionate });
    nomeInput.value = '';
    document.querySelectorAll('#cibi input:checked').forEach(cb => cb.checked = false);
    document.querySelectorAll('#bevande input:checked').forEach(cb => cb.checked = false);
  }
  function aggiornaDati(snapshot) {
    const dati = snapshot.val() || {};
    listaEl.innerHTML = '';
    const partecipanti = Object.entries(dati).map(([id, p]) => ({ id, ...p }));
    totPartecipantiEl.textContent = partecipanti.length === 1 ? '1 partecipante' : partecipanti.length + ' partecipanti';
    partecipanti.forEach(({id, nome, cibi = [], bevande = []}) => {
      const li = document.createElement('li');
      li.textContent = `${nome} — Cibi: ${cibi.join(', ') || '—'} — Bevande: ${bevande.join(', ') || '—'}`;
      const btn = document.createElement('button');
      btn.textContent = 'Rimuovi';
      btn.onclick = () => database.ref('partecipanti/' + id).remove();
      li.appendChild(btn);
      listaEl.appendChild(li);
    });
    const contaCibi = {};
    const contaBevande = {};
    partecipanti.forEach(({cibi = [], bevande = []}) => {
      cibi.forEach(cibo => { contaCibi[cibo] = (contaCibi[cibo] || 0) + 1; });
      bevande.forEach(bevanda => { contaBevande[bevanda] = (contaBevande[bevanda] || 0) + 1; });
    });
    graficoCibi = aggiornaGraficoBarre(graficoCibi, 'graficoCibi', contaCibi, 'Cibi');
    graficoBevande = aggiornaGraficoBarre(graficoBevande, 'graficoBevande', contaBevande, 'Bevande');
  }
  function aggiornaGraficoBarre(chart, canvasId, dataObj, label) {
    const labels = Object.keys(dataObj);
    const data = Object.values(dataObj);
    const ctx = document.getElementById(canvasId).getContext('2d');
    if (!chart) {
      return new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label, data, backgroundColor: '#27ae60', borderRadius: 6, maxBarThickness: 40 }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
          plugins: { legend: { display: false } }
        }
      });
    } else {
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update();
      return chart;
    }
  }
  database.ref('partecipanti').on('value', snapshot => {
    if (!graficoCibi) graficoCibi = aggiornaGraficoBarre(null, 'graficoCibi', {}, 'Cibi');
    if (!graficoBevande) graficoBevande = aggiornaGraficoBarre(null, 'graficoBevande', {}, 'Bevande');
    aggiornaDati(snapshot);
  });
</script>
</body>
</html>

