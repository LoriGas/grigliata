<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grigliata Casa Gas - Con Firebase</title>

<!-- Stili base -->
<style>
  body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; margin-left: auto; margin-right: auto; }
  h1 { text-align: center; }
  .section { margin-bottom: 20px; }
  .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
  label { display: flex; align-items: center; gap: 5px; }
  ul { padding-left: 20px; }
  li { margin-bottom: 10px; }
  button { margin-left: 10px; cursor: pointer; }
  @media (max-width: 480px) {
    .checkbox-group { flex-direction: column; }
  }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<body>

<h1>Grigliata Casa Gas</h1>

<div class="section">
  <label>Nome: <input type="text" id="nome" autocomplete="off" /></label>
</div>

<div class="section">
  <h3>Cibi</h3>
  <div id="cibi" class="checkbox-group"></div>
</div>

<div class="section">
  <h3>Bevande</h3>
  <div id="bevande" class="checkbox-group"></div>
</div>

<button onclick="aggiungiPartecipante()">Aggiungi</button>

<h2>Lista partecipanti</h2>
<ul id="lista"></ul>

<canvas id="graficoCibi" width="400" height="200"></canvas>
<canvas id="graficoBevande" width="400" height="200"></canvas>

<script>
  // Config Firebase (metti qui la tua config)
  const firebaseConfig = {
    apiKey: "AIzaSyAMZ6Kuxh0e4wD8mwJWQeWvVaBbeYtYhxo",
    authDomain: "grigliata-e3c22.firebaseapp.com",
    databaseURL: "https://grigliata-e3c22-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "grigliata-e3c22",
    storageBucket: "grigliata-e3c22.appspot.com",
    messagingSenderId: "403555200046",
    appId: "1:403555200046:web:3074852ad1ae6689a083bf",
    measurementId: "G-K65LG7VYCW"
  };

  // Inizializza Firebase
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Opzioni
  const opzioniCibi = ["Hamburger", "Salamelle", "Braciole", "Wurstel", "Salsiccia", "Coppa", "Pancetta"];
  const opzioniBevande = ["Acqua", "CocaCola", "Spritz", "Birra", "Estathe", "Gin Lemon"];

  // Crea checkbox in pagina
  function creaCheckbox(containerId, opzioni) {
    const container = document.getElementById(containerId);
    opzioni.forEach(opt => {
      const label = document.createElement('label');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.value = opt;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(opt));
      container.appendChild(label);
    });
  }

  creaCheckbox('cibi', opzioniCibi);
  creaCheckbox('bevande', opzioniBevande);

  // Riferimenti DOM
  const listaEl = document.getElementById('lista');
  const nomeInput = document.getElementById('nome');

  // Grafici
  let graficoCibi, graficoBevande;

  // Aggiunge partecipante nel DB
  function aggiungiPartecipante() {
    const nome = nomeInput.value.trim();
    if (!nome) {
      alert('Inserisci un nome');
      return;
    }
    const cibiSelezionati = Array.from(document.querySelectorAll('#cibi input:checked')).map(cb => cb.value);
    const bevandeSelezionate = Array.from(document.querySelectorAll('#bevande input:checked')).map(cb => cb.value);

    if(cibiSelezionati.length === 0 && bevandeSelezionate.length === 0) {
      alert('Seleziona almeno un cibo o una bevanda');
      return;
    }

    // Crea nuovo partecipante con ID univoco
    const newRef = database.ref('partecipanti').push();
    newRef.set({
      nome,
      cibi: cibiSelezionati,
      bevande: bevandeSelezionate
    });

    // Pulisci form
    nomeInput.value = '';
    document.querySelectorAll('#cibi input:checked').forEach(cb => cb.checked = false);
    document.querySelectorAll('#bevande input:checked').forEach(cb => cb.checked = false);
  }

  // Aggiorna lista e grafici leggendo da DB in tempo reale
  function aggiornaDati(snapshot) {
    const dati = snapshot.val() || {};
    listaEl.innerHTML = '';

    const partecipanti = Object.entries(dati).map(([id, p]) => ({ id, ...p }));

    // Crea lista
    partecipanti.forEach(({id, nome, cibi, bevande}) => {
      const li = document.createElement('li');
      li.textContent = `${nome} - Cibi: ${cibi.join(', ')} - Bevande: ${bevande.join(', ')}`;

      const btn = document.createElement('button');
      btn.textContent = 'Rimuovi';
      btn.onclick = () => {
        database.ref('partecipanti/' + id).remove();
      };
      li.appendChild(btn);
      listaEl.appendChild(li);
    });

    // Conta per grafici
    const contaCibi = {};
    const contaBevande = {};

    partecipanti.forEach(({cibi, bevande}) => {
      cibi.forEach(c => contaCibi[c] = (contaCibi[c] || 0) + 1);
      bevande.forEach(b => contaBevande[b] = (contaBevande[b] || 0) + 1);
    });

    aggiornaGrafici(contaCibi, contaBevande);
  }

  // Funzione per aggiornare i grafici
  function aggiornaGrafici(contaCibi, contaBevande) {
    const coloriCibi = generaColori(Object.keys(contaCibi).length);
    const coloriBevande = generaColori(Object.keys(contaBevande).length);

    if(graficoCibi) graficoCibi.destroy();
    if(graficoBevande) graficoBevande.destroy();

    graficoCibi = new Chart(document.getElementById('graficoCibi'), {
      type: 'pie',
      data: {
        labels: Object.keys(contaCibi),
        datasets: [{
          data: Object.values(contaCibi),
          backgroundColor: coloriCibi
        }]
      }
    });

    graficoBevande = new Chart(document.getElementById('graficoBevande'), {
      type: 'pie',
      data: {
        labels: Object.keys(contaBevande),
        datasets: [{
          data: Object.values(contaBevande),
          backgroundColor: coloriBevande
        }]
      }
    });
  }

  // Genera colori casuali
  function generaColori(n) {
    return Array.from({ length: n }, () => `hsl(${Math.random() * 360}, 70%, 60%)`);
  }

  // Ascolta cambiamenti in realtime sul DB
  database.ref('partecipanti').on('value', aggiornaDati);

</script>

</body>
</html>
